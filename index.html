<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Żuzel</title>
    <!-- https://pastebin.com/t72hFmf3 -->
    <!-- https://pastebin.com/bwjMTaph -->
    <style>
        #main {
            margin: auto;
            text-align: center;
            font-family: monospace;
        }

        canvas {
            border: solid 1px;
        }

        button {
            width: 100px;
            height: 50px;
        }

        button:disabled {
            color: black;
            background-color: #ffffff;
        }

        input:disabled {
            color: black;
            background-color: #ffffff;
        }

        .menu {
            margin: auto;
            height: 50px;
            border: 1px solid black;
            margin-top: 10px;

            display: flex;
            justify-content: center;
            align-items: center;
        }

        .menu * {
            margin: 5px;
        }

        .menu input {
            margin-right: 20px;
        }

        .menu button {
            width: 100px;
            height: 100%;
            margin: 0;
        }
    </style>
</head>

<body onkeydown="klaw1(event)" onkeyup="klaw2(event)">
    <script defer>
        //helpers
        let game_state = ""

        //assets
        let kierunek = ""
        let kierunek_info = ""
        let wybrane_kierunki = []
        let kierunki = []
        let players = []
        let players_kol = [0, 0, 0, 0]
        let loading = 0

        let img = new Image();
        img.src = "grass_tx3.jpg";
        img.onload = () => {
            loading++
            game.assets_check(loading)
        }

        let img2 = new Image();
        img2.src = "dirt_tx4.jpg";
        img2.onload = () => {
            loading++
            game.assets_check(loading)
        }

        //class Player
        class Player {
            constructor(name, key1, opis_key1, key2, opis_key2, number) {
                this.alive = true
                this.number = number
                this.color = Math.random() * 255 + "," + Math.random() * 255 + "," + Math.random() * 255
                this.name = name
                this.key1 = key1
                this.key2 = key2
                this.opis_key1 = opis_key1
                this.opis_key2 = opis_key2
                this.angle = 90
                this.speed = 5
                this.x = game.wid / 2
                this.y = game.hei / 2 + game.hei / 5 + ((game.hei / 2 - game.hei / 5) / 5) * this.number
                this.tab = [{
                    x: this.x - this.speed,
                    y: this.y
                }, {
                    x: this.x,
                    y: this.y
                }]

                this.generate_player()
                this.menu()
            }

            generate_player() {
                let cv = document.getElementById("canvas")
                let ctx = cv.getContext("2d")
                ctx.strokeStyle = "rgba(" + this.color + ",1)"
                ctx.lineWidth = game.lwid
                ctx.beginPath()
                ctx.moveTo(this.x - this.speed, this.y)
                ctx.lineTo(this.x, this.y)
                ctx.closePath()
                ctx.stroke()
            }

            game_init() {
                this.menu_name_input.disabled = true
                this.menu_bt1.disabled = true
                this.menu_bt2.disabled = true
                this.menu_del.disabled = true
                this.menu_bt1.innerText = this.opis_key1
                this.menu_bt2.innerText = this.opis_key2
                this.name = this.menu_name_input.value
                this.generate_player()
            }

            movement(temp_key) {
                if (temp_key.includes(this.key2)) {        //prawo
                    this.angle -= 10
                } else if (temp_key.includes(this.key1)) {     //lewo
                    this.angle += 10
                }

                let cv = document.getElementById("canvas")
                let ctx = cv.getContext("2d")
                ctx.lineWidth = game.lwid
                for (let i = 1; i < this.tab.length; i++) {
                    ctx.strokeStyle = "rgba(0,0,0," + (i / (this.tab.length - 1)) + ")"
                    ctx.beginPath()
                    ctx.moveTo(this.tab[i - 1].x, this.tab[i - 1].y)
                    ctx.lineTo(this.tab[i].x, this.tab[i].y)
                    ctx.stroke()
                    ctx.closePath()
                }

                ctx.beginPath()
                ctx.moveTo(this.tab[this.tab.length - 1].x, this.tab[this.tab.length - 1].y)
                ctx.strokeStyle = "rgba(" + this.color + ",1)"
                this.x = this.x + (this.speed * Math.sin((2 * Math.PI / 360) * this.angle))
                this.y = this.y + (this.speed * Math.cos((2 * Math.PI / 360) * this.angle))
                ctx.lineTo(this.x, this.y)
                ctx.stroke()

                this.tab.push({
                    x: this.x,
                    y: this.y
                })
                if (this.tab.length > 19) {
                    this.tab.shift()
                }
                this.movement_check()
            }

            movement_check() {
                let temp_path_check = 0
                let cv = document.getElementById("canvas")
                let ctx = cv.getContext("2d")
                ctx.lineWidth = this.lwid
                ctx.strokeStyle = "rgb(0,0,0)"

                ctx.beginPath()
                ctx.arc(game.hei / 2, game.hei / 2, game.hei / 2 - game.lwid / 2, (2 * Math.PI) / 360 * 270, (2 * Math.PI) / 360 * 90, true);
                ctx.arc(game.wid - (game.hei / 2), game.hei / 2, game.hei - (game.hei / 2) - game.lwid / 2, (2 * Math.PI) / 360 * 90, (2 * Math.PI) / 360 * 270, true);
                ctx.closePath()
                if (!ctx.isPointInPath(this.x, this.y)) {
                    this.speed = 0
                    this.alive = false
                }

                ctx.beginPath()
                ctx.arc(game.hei / 2, game.hei / 2, game.hei / 5, (2 * Math.PI) / 360 * 90, (2 * Math.PI) / 360 * 270);
                ctx.arc(game.wid - (game.hei / 2), game.hei / 2, game.hei / 5, (2 * Math.PI) / 360 * 270, (2 * Math.PI) / 360 * 90);
                ctx.closePath()
                if (ctx.isPointInPath(this.x, this.y)) {
                    this.speed = 0
                    this.alive = false
                }

            }

            menu() {
                this.menu_main = document.createElement("div")
                this.menu_name = document.createElement("label")
                this.menu_name_input = document.createElement("input")
                this.menu_bt1 = document.createElement("button")
                this.menu_bt2 = document.createElement("button")
                this.menu_del = document.createElement("button")

                this.menu_main.className = "menu"
                this.menu_name.innerText = "Nazwa gracza:"
                this.menu_name_input.value = "Player" + this.number
                this.menu_bt1.innerText = this.opis_key1
                this.menu_bt2.innerText = this.opis_key2
                this.menu_del.innerText = "Usuń"

                this.menu_bt1.onclick = function (el) {
                    this.player_key_change(el.target, "lewo")
                }.bind(this)

                this.menu_bt2.onclick = function (el) {
                    this.player_key_change(el.target, "prawo")
                }.bind(this)

                this.menu_del.onclick = function (el) {
                    this.player_del(el.target)
                }.bind(this)

                this.menu_main.append(this.menu_name, this.menu_name_input, this.menu_bt1, this.menu_bt2, this.menu_del)
                document.getElementById("main").append(this.menu_main)
            }

            player_key_change(el, temp) {
                el.innerText = "wybierz klawisz"
                document.getElementById("bt_start").disabled = true
                let change_key = setInterval(() => {
                    if (kierunek != "") {
                        if (temp == "lewo") {
                            if (wybrane_kierunki.includes(kierunek) && kierunek != this.key1) {
                                el.innerText = "zajęty klawisz"
                            } else {
                                wybrane_kierunki.splice(wybrane_kierunki.indexOf(this.key1), 1)
                                wybrane_kierunki.push(kierunek)
                                el.innerText = kierunek_info
                                this.key1 = kierunek
                                this.opis_key1 = kierunek_info

                                document.getElementById("bt_start").disabled = false
                                clearInterval(change_key)
                            }

                        } else if (temp == "prawo") {
                            if (wybrane_kierunki.includes(kierunek) && kierunek != this.key2) {
                                el.innerText = "zajęty klawisz"
                            } else {
                                wybrane_kierunki.splice(wybrane_kierunki.indexOf(this.key2), 1)
                                wybrane_kierunki.push(kierunek)
                                el.innerText = kierunek_info
                                this.key2 = kierunek
                                this.opis_key2 = kierunek_info

                                document.getElementById("bt_start").disabled = false
                                clearInterval(change_key)
                            }
                        }
                    }
                }, 10);
            }

            player_del() {
                wybrane_kierunki.splice(wybrane_kierunki.indexOf(this.key1), 1)
                wybrane_kierunki.splice(wybrane_kierunki.indexOf(this.key2), 1)
                document.getElementById("main").removeChild(this.menu_main)
                players_kol[this.number - 1] = 0
                game.del(this)
            }
        }

        //main object
        let game = {
            wid: 600,
            hei: 300,
            lwid: 4,
            assets: 2,

            assets_check: function (x) {
                if (this.assets <= x) {
                    game.main()
                }
            },

            main: function () {
                let main = document.createElement("div")
                main.id = "main"
                main.style.width = this.wid + "px"
                document.body.append(main)

                if (this.wid < this.hei) {
                    this.hei = this.wid
                }
                this.generate_map()
            },

            generate_map: function () {
                let cv = document.createElement("canvas")
                cv.id = "canvas"
                cv.width = this.wid
                cv.height = this.hei

                let bt_start = document.createElement("button")
                bt_start.id = "bt_start"
                bt_start.addEventListener("click", this.start)
                bt_start.innerText = "Start"
                bt_start.disabled = true

                let bt_init_player = document.createElement("button")
                bt_init_player.id = "bt_init_player"
                bt_init_player.addEventListener("click", this.init_player)
                bt_init_player.innerText = "Dodaj gracza"

                document.getElementById("main").append(cv, bt_start, bt_init_player)
                this.render()
            },

            render: function () {
                let cv = document.getElementById("canvas")
                let ctx = cv.getContext("2d")
                let pat = ctx.createPattern(img, 'repeat')
                let pat2 = ctx.createPattern(img2, 'repeat')

                ctx.clearRect(0, 0, this.wid, this.hei)

                ctx.lineWidth = this.lwid
                ctx.strokeStyle = "rgb(0,0,0)"
                ctx.fillStyle = pat;
                ctx.beginPath()
                ctx.moveTo(0, 0)
                ctx.lineTo(this.wid, 0)
                ctx.lineTo(this.wid, this.hei)
                ctx.lineTo(0, this.hei)
                ctx.closePath()
                ctx.fill()

                ctx.fillStyle = pat2;
                ctx.beginPath()
                ctx.arc(this.hei / 2, this.hei / 2, this.hei / 2 - this.lwid / 2, (2 * Math.PI) / 360 * 270, (2 * Math.PI) / 360 * 90, true);
                ctx.arc(this.wid - (this.hei / 2), this.hei / 2, this.hei - (this.hei / 2) - this.lwid / 2, (2 * Math.PI) / 360 * 90, (2 * Math.PI) / 360 * 270, true);
                ctx.closePath()
                ctx.stroke()
                ctx.fill()

                ctx.fillStyle = pat;
                ctx.beginPath()
                ctx.arc(this.hei / 2, this.hei / 2, this.hei / 5, (2 * Math.PI) / 360 * 90, (2 * Math.PI) / 360 * 270);
                ctx.arc(this.wid - (this.hei / 2), this.hei / 2, this.hei / 5, (2 * Math.PI) / 360 * 270, (2 * Math.PI) / 360 * 90);
                ctx.closePath()
                ctx.stroke()
                ctx.fill()
            },

            start: function () {
                document.getElementById("bt_init_player").disabled = true
                document.getElementById("bt_start").disabled = true
                game.render()
                players.forEach(pl => {
                    pl.game_init(kierunki)
                })
                setInterval(() => {
                    game.render()
                    players.forEach(pl => {
                        pl.movement(kierunki)
                    })
                }, 500);

            },

            init_player: function () {
                document.getElementById("bt_start").disabled = false
                if (players.length < 4) {
                    for (let i = 0; i < players_kol.length; i++) {
                        if (players_kol[i] == 0) {
                            if (!players_kol.includes(1)) {
                                players.push(new Player("Player1", "KeyQ", "q", "KeyW", "w", i + 1))
                                wybrane_kierunki.push("KeyQ", "KeyW")
                                players_kol[i] = 1
                                break
                            } else if (!players_kol.includes(2)) {
                                players.push(new Player("Player2", "KeyC", "c", "KeyV", "v", i + 1))
                                wybrane_kierunki.push("KeyC", "KeyV")
                                players_kol[i] = 2
                                break
                            } else if (!players_kol.includes(3)) {
                                players.push(new Player("Player3", "KeyY", "y", "KeyU", "u", i + 1))
                                wybrane_kierunki.push("KeyY", "KeyU")
                                players_kol[i] = 3
                                break
                            } else if (!players_kol.includes(4)) {
                                players.push(new Player("Player4", "KeyK", "k", "KeyL", "l", i + 1))
                                wybrane_kierunki.push("KeyK", "KeyL")
                                players_kol[i] = 4
                                break
                            }
                        }
                    }
                } else {
                    document.getElementById("bt_init_player").innerText = "Limit graczy"
                    document.getElementById("bt_init_player").disabled = true
                }
                if (players.length == 4) {
                    document.getElementById("bt_init_player").innerText = "Limit graczy"
                    document.getElementById("bt_init_player").disabled = true
                }

            },

            del: function (gracz) {
                players.splice(players.indexOf(gracz), 1)
                document.getElementById("bt_init_player").disabled = false
                document.getElementById("bt_init_player").innerText = "Dodaj gracza"
                this.render()
                players.forEach(pl => {
                    pl.generate_player()
                })
            }
        }

        //klawisze
        function klaw1(e) {
            if (!kierunki.includes(e.code)) {
                kierunki.push(e.code)
            }
            kierunek = e.code
            kierunek_info = e.key
        }

        function klaw2(e) {
            kierunki.splice(kierunki.indexOf(e.code), 1)
            kierunek = ""
            kierunek_info = ""
        }

    </script>
</body>

</html>