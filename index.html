<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Å»uzel</title>
    <!-- https://pastebin.com/t72hFmf3 -->
    <!-- https://pastebin.com/bwjMTaph -->
    <style>
        #main {
            margin: auto;
            text-align: center;
            font-family: monospace;
        }

        canvas {
            border: solid 1px;
        }

        button {
            width: 100px;
            height: 50px;
        }

        .menu {
            margin: auto;
            height: 50px;
            border: 1px solid black;
            margin-top: 10px;

            display: flex;
            justify-content: center;
            align-items: center;
        }

        .menu * {
            margin: 5px;
        }

        .menu button {
            width: 120px;
            height: 25px;

        }
    </style>
</head>

<body onkeydown="klaw1(event)" onkeyup="klaw2(event)">
    <script defer>
        //assets
        let state = ""

        let kierunek = ""
        let opis_kierunek = ""
        let help = false
        let players = []
        let loading = 0

        let img = new Image();
        img.src = "grass_tx3.jpg";
        img.onload = () => {
            loading++
            game.assets_check(loading)
        }

        let img2 = new Image();
        img2.src = "dirt_tx4.jpg";
        img2.onload = () => {
            loading++
            game.assets_check(loading)
        }

        //class Player
        class Player {
            constructor(name, key1, opis_key1, key2, opis_key2) {
                this.name = name
                this.key1 = key1
                this.key2 = key2
                this.opis_key1 = opis_key1
                this.opis_key2 = opis_key2
                this.angle = 90
                this.speed = 10
                this.x = game.wid / 2
                this.y = game.hei / 2 + game.hei / 5 + ((game.hei / 2 - game.hei / 5) / 5) * (players.length + 1)
                this.tab = [{
                    x: this.x - 10,
                    y: this.y
                }, {
                    x: this.x,
                    y: this.y
                }]

                let cv = document.getElementById("canvas")
                let ctx = cv.getContext("2d")
                ctx.lineWidth = game.lwid
                ctx.beginPath()
                ctx.moveTo(this.x - 10, this.y)
                ctx.lineTo(this.x, this.y)
                ctx.closePath()
                ctx.stroke()
                this.menu()
            }

            movement(temp_key) {
                this.menu_bt1.innerText = this.opis_key1
                this.menu_bt2.innerText = this.opis_key2
                this.menu_bt1.disabled = true
                this.menu_bt2.disabled = true

                if (temp_key == this.key2) {        //prawo
                    this.angle -= 10
                } else if (temp_key == this.key1) {     //lewo
                    this.angle += 10
                }

                let cv = document.getElementById("canvas")
                let ctx = cv.getContext("2d")
                ctx.lineWidth = game.lwid
                ctx.beginPath()
                ctx.moveTo(this.tab[0].x, this.tab[0].y)
                for (let i = 1; i < this.tab.length; i++) {
                    ctx.lineTo(this.tab[i].x, this.tab[i].y)
                }
                this.x = this.x + (this.speed * Math.sin((2 * Math.PI / 360) * this.angle))
                this.y = this.y + (this.speed * Math.cos((2 * Math.PI / 360) * this.angle))
                ctx.lineTo(this.x, this.y)
                ctx.stroke()

                this.tab.push({
                    x: this.x,
                    y: this.y
                })
                if (this.tab.length > 9) {
                    this.tab.shift()
                }
            }

            menu() {
                this.menu_main = document.createElement("div")
                this.menu_name = document.createElement("label")
                this.menu_name_input = document.createElement("input")
                this.menu_bt1 = document.createElement("button")
                this.menu_bt2 = document.createElement("button")

                this.menu_main.className = "menu"
                this.menu_name.innerText = "Nazwa gracza:"
                this.menu_name_input.value = "Player" + (players.length + 1)
                this.menu_bt1.innerText = this.opis_key1
                this.menu_bt2.innerText = this.opis_key2

                this.menu_bt1.onclick = function () {
                    this.menu_bt1.innerText = "wybierz klawisz"
                }.bind(this)

                this.menu_main.append(this.menu_name, this.menu_name_input, this.menu_bt1, this.menu_bt2)
                document.getElementById("main").append(this.menu_main)
            }
        }

        //main object
        let game = {
            wid: 600,
            hei: 300,
            lwid: 4,
            assets: 2,

            assets_check: function (x) {
                if (this.assets <= x) {
                    game.main()
                }
            },

            main: function () {
                let main = document.createElement("div")
                main.id = "main"
                main.style.width = this.wid + "px"
                document.body.append(main)

                if (this.wid < this.hei) {
                    this.hei = this.wid
                }
                this.generate_map()
            },

            generate_map: function () {
                let cv = document.createElement("canvas")
                cv.id = "canvas"
                cv.width = this.wid
                cv.height = this.hei

                let bt_start = document.createElement("button")
                bt_start.addEventListener("click", this.start)
                bt_start.innerText = "Start"

                let bt_init_player = document.createElement("button")
                bt_init_player.id = "bt_init_player"
                bt_init_player.addEventListener("click", this.init_player)
                bt_init_player.innerText = "Dodaj gracza"

                document.getElementById("main").append(cv, bt_start, bt_init_player)
                this.render()
            },

            render: function () {
                let cv = document.getElementById("canvas")
                let ctx = cv.getContext("2d")
                let pat = ctx.createPattern(img, 'repeat')
                let pat2 = ctx.createPattern(img2, 'repeat')

                ctx.clearRect(0, 0, this.wid, this.hei)

                ctx.lineWidth = this.lwid
                ctx.fillStyle = pat;
                ctx.beginPath()
                ctx.moveTo(0, 0)
                ctx.lineTo(this.wid, 0)
                ctx.lineTo(this.wid, this.hei)
                ctx.lineTo(0, this.hei)
                ctx.closePath()
                ctx.fill()

                ctx.fillStyle = pat2;
                ctx.beginPath()
                ctx.arc(this.hei / 2, this.hei / 2, this.hei / 2 - this.lwid / 2, (2 * Math.PI) / 360 * 270, (2 * Math.PI) / 360 * 90, true);
                ctx.arc(this.wid - (this.hei / 2), this.hei / 2, this.hei - (this.hei / 2) - this.lwid / 2, (2 * Math.PI) / 360 * 90, (2 * Math.PI) / 360 * 270, true);
                ctx.closePath()
                ctx.stroke()
                ctx.fill()

                ctx.fillStyle = pat;
                ctx.beginPath()
                ctx.arc(this.hei / 2, this.hei / 2, this.hei / 5, (2 * Math.PI) / 360 * 90, (2 * Math.PI) / 360 * 270);
                ctx.arc(this.wid - (this.hei / 2), this.hei / 2, this.hei / 5, (2 * Math.PI) / 360 * 270, (2 * Math.PI) / 360 * 90);
                ctx.closePath()
                ctx.stroke()
                ctx.fill()
            },

            start: function () {
                setInterval(() => {
                    game.render()
                    players.forEach(pl => {
                        pl.movement(kierunek)
                        pl.menu_name_input.disabled = true
                        pl
                    })
                    console.log(kierunek)
                    if (help) {
                        help = false
                        kierunek = ""
                    }
                }, 200);

            },

            init_player: function () {
                if (players.length == 0) {
                    players.push(new Player("ala", "KeyQ", "q", "KeyW", "w"))
                } else if (players.length == 1) {
                    players.push(new Player("ala", "KeyC", "c", "KeyV", "v"))
                } else if (players.length == 2) {
                    players.push(new Player("ala", "KeyY", "y", "KeyU", "u"))
                } else if (players.length == 3) {
                    players.push(new Player("ala", "KeyK", "k", "KeyL", "l"))
                    document.getElementById("bt_init_player").innerText = "Limit graczy"
                    document.getElementById("bt_init_player").disabled = true
                } else {
                    document.getElementById("bt_init_player").innerText = "Limit graczy"
                    document.getElementById("bt_init_player").disabled = true
                }
            },
        }

        //klawisze
        function klaw1(e) {
            help = false
            kierunek = e.code
            if (state == "") {

            } else if (state == "pick") {
                kierunek = e.code
                opis_kierunek = e.key
            }
        }

        function klaw2(e) {
            help = true
            if (state) {

            } else {
                kierunek = ""
                opis_kierunek = ""
            }
        }

    </script>
</body>

</html>